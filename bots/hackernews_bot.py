from bots.base import BotBase
import json
import re


class HackerNewsBot(BotBase):
    interval = 60 * 60  # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
    file_prefix = "thehackernews-Telegram-"
    output_folder = "hackernews"
    output_prefix = "hackernews"
    min_files_required = 3  # ç½‘ç»œå®‰å…¨ä¿¡æ¯å¯ä»¥å°‘ä¸€äº›ä¹Ÿèƒ½ç”Ÿæˆæœ‰ä»·å€¼çš„å†…å®¹

    def extract_info_from_file(self, file_path):
        """ä»thehackernewsæ–‡ä»¶ä¸­æå–ä¿¡æ¯ï¼Œåªä¿ç•™æ ‡é¢˜å’Œæè¿°"""
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                article = json.load(f)

            # æ¸…ç†æ ‡é¢˜å’Œä½œè€…ä¿¡æ¯
            title = article.get("title", "æ— æ ‡é¢˜")
            # ç§»é™¤å¯èƒ½çš„emojiå’Œå…¶ä»–ç‰¹æ®Šå­—ç¬¦
            title = re.sub(r"[ğŸ”¸ğŸ”¹ğŸ”»ğŸ”ºâš ï¸]", "", title)

            # æå–ä½œè€…ä¿¡æ¯
            author = article.get("author", "")

            # ä»æè¿°ä¸­æå–çº¯æ–‡æœ¬å†…å®¹
            description = self.clean_html(article.get("description", ""))

            # ç§»é™¤å¹¿å‘Šå’Œè¥é”€é“¾æ¥
            description = re.sub(r"Sign up for.*?(?=\n|$)", "", description)
            description = re.sub(r"Join them.*?(?=\n|$)", "", description)

            # ç§»é™¤å¤šä½™çš„ç©ºè¡Œ
            description = re.sub(r"\n\s*\n", "\n\n", description).strip()

            # åªè¿”å›æ ‡é¢˜å’Œæè¿°
            info = f"æ ‡é¢˜ï¼š{title.strip()}\n"
            if author:
                info += f"ä½œè€…ï¼š{author}\n"
            info += f"æè¿°ï¼š{description}\n"

            return info
        except Exception as e:
            self.logger.error(f"æå–thehackernewsæ–‡ä»¶ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            return None

    def generate_title_prompt(self, article_content):
        """ç”Ÿæˆç§‘æŠ€æ–°é—»æ ‡é¢˜çš„æç¤ºè¯"""
        return f"""
        ä½ ç°åœ¨æ˜¯ä¸€ä¸ªç§‘æŠ€èµ„è®¯å…¬ä¼—å·ç¼–è¾‘ï¼Œéœ€è¦æ ¹æ®ä»¥ä¸‹å†…å®¹ç”Ÿæˆä¸€ä¸ªå¸å¼•äººçš„æ ‡é¢˜ï¼Œè¦èƒ½å¢åŠ ç‚¹å‡»é‡ï¼š
        
        æ–‡ç« å†…å®¹: {article_content}
        
        è¯·ç”Ÿæˆä¸€ä¸ªå…³äºç§‘æŠ€é¢†åŸŸçš„å¸å¼•äººæ ‡é¢˜ï¼Œæ ‡é¢˜åº”å½“å¼•äººæ³¨ç›®ä¸”ä¸“ä¸šï¼Œèƒ½å¼•èµ·ç§‘æŠ€çˆ±å¥½è€…çš„å…´è¶£ã€‚æ ‡é¢˜å¯ä»¥æ¶µç›–ç§‘æŠ€åˆ›æ–°ã€æ•°å­—äº§å“ã€AIå‘å±•ã€ç¼–ç¨‹æŠ€æœ¯ã€ç§‘æŠ€å…¬å¸åŠ¨æ€ç­‰å„æ–¹é¢å†…å®¹ã€‚
        """

    def generate_article_prompt(self, articles_info):
        """ç”Ÿæˆç§‘æŠ€æ–‡ç« çš„æç¤ºè¯"""
        return f"""
        ä½ ç°åœ¨æ˜¯ä¸€ä¸ªç§‘æŠ€èµ„è®¯å…¬ä¼—å·ç¼–è¾‘ï¼Œéœ€è¦æ ¹æ®ä»¥ä¸‹å‡ ç¯‡æ–‡ç« çš„ä¿¡æ¯æ•´åˆç”Ÿæˆä¸€ç¯‡ç»¼åˆæ€§ç§‘æŠ€èµ„è®¯å…¬ä¼—å·æ–‡ç« ï¼š
        
        æ–‡ç« é›†åˆ: {articles_info}
        
        è¯·ç”Ÿæˆä¸€ç¯‡å…³äºæœ€æ–°ç§‘æŠ€åŠ¨æ€ã€åˆ›æ–°è¶‹åŠ¿å’ŒæŠ€æœ¯å‘å±•çš„å…¬ä¼—å·æ–‡ç« ï¼Œè¦æ±‚ï¼š
        1. æŒ‰ç§‘æŠ€é¢†åŸŸåˆ†ç±»ï¼ˆå¦‚AIã€ç¡¬ä»¶ã€è½¯ä»¶å¼€å‘ã€äº’è”ç½‘æœåŠ¡ã€ç§‘æŠ€å…¬å¸åŠ¨æ€ç­‰ï¼‰
        2. è§£é‡Šå¤æ‚çš„æŠ€æœ¯æ¦‚å¿µï¼Œä½¿éä¸“ä¸šè¯»è€…ä¹Ÿèƒ½ç†è§£
        3. é‡ç‚¹å…³æ³¨æœ€æ–°çš„æŠ€æœ¯çªç ´å’Œç§‘æŠ€è¶‹åŠ¿
        4. å¯¹é‡è¦ç§‘æŠ€äº‹ä»¶æä¾›è¯¦ç»†åˆ†æå’ŒèƒŒæ™¯ä¿¡æ¯
        5. åŒ…å«å®ç”¨çš„ç§‘æŠ€äº§å“ä½¿ç”¨å»ºè®®å’Œè§‚ç‚¹è¯„è®º
        6. ä¿ç•™é‡è¦çš„æŠ€æœ¯ç»†èŠ‚å’Œå…³é”®é“¾æ¥
        7. æ–‡æœ«æ€»ç»“å½“å‰ç§‘æŠ€å‘å±•æ€åŠ¿å¹¶æä¾›è§è§£
        
        ç”Ÿæˆä¸€ç¯‡æ—¢ä¸“ä¸šåˆå®ç”¨çš„ç§‘æŠ€èµ„è®¯æ–‡ç« ï¼Œå¸®åŠ©è¯»è€…äº†è§£å’ŒæŠŠæ¡æœ€æ–°ç§‘æŠ€åŠ¨æ€ã€‚
        """
